name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3Ô∏è‚É£ Install Pinata SDK
      - name: Install Pinata SDK
        run: npm install pinata-web3

      # 4Ô∏è‚É£ Create and run upload script
      - name: Upload to Pinata
        id: pinata_upload
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          cat << 'SCRIPT_EOF' > upload.mjs
          import { PinataSDK } from "pinata-web3";
          import fs from "fs";

          const pinata = new PinataSDK({
            pinataJwt: process.env.PINATA_JWT
          });

          async function main() {
            try {
              console.log("Uploading site folder to Pinata...");
          
              const upload = await pinata.upload.folder("site", {
                name: "site-folder"
              });
          
              console.log("Upload successful!");
              console.log("CID:", upload.IpfsHash);
          
              // Write to GitHub output
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `cid=${upload.IpfsHash}\n`);
          
            } catch (error) {
              console.error("Upload failed:", error.message);
              process.exit(1);
            }
          }

          main();
          SCRIPT_EOF

          node upload.mjs

      # 5Ô∏è‚É£ Show final URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "üîó https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Your index.html is at the root and will load automatically!"
          echo "=========================================="