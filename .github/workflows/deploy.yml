name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3Ô∏è‚É£ Install Pinata SDK
      - name: Install Pinata SDK
        run: npm install @pinata/sdk

      # 4Ô∏è‚É£ Create and run upload script
      - name: Upload to Pinata
        id: pinata_upload
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          cat << 'SCRIPT_EOF' > upload.js
          const pinataSDK = require('@pinata/sdk');
          const fs = require('fs');

          async function main() {
            try {
              // Initialize Pinata with JWT
              const pinata = new pinataSDK({ pinataJWTKey: process.env.PINATA_JWT });
          
              console.log("Uploading site folder to Pinata...");
          
              // Upload the folder
              const result = await pinata.pinFromFS('./site', {
                pinataMetadata: {
                  name: 'site'
                },
                pinataOptions: {
                  wrapWithDirectory: true
                }
              });
          
              console.log("Upload successful!");
              console.log("CID:", result.IpfsHash);
          
              // Write to GitHub output
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `cid=${result.IpfsHash}\n`);
          
            } catch (error) {
              console.error("Upload failed:", error.message);
              process.exit(1);
            }
          }

          main();
          SCRIPT_EOF

          node upload.js

      # 5Ô∏è‚É£ Show final URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}/site/"
          echo "üîó https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/site/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}/site/"
          echo ""
          echo "Your index.html is at: .../site/index.html"
          echo "=========================================="