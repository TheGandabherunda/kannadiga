name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Install IPFS Kubo
      - name: Install IPFS
        run: |
          wget https://dist.ipfs.tech/kubo/v0.24.0/kubo_v0.24.0_linux-amd64.tar.gz
          tar -xvzf kubo_v0.24.0_linux-amd64.tar.gz
          sudo bash kubo/install.sh
          ipfs --version

      # 3Ô∏è‚É£ Initialize IPFS
      - name: Initialize IPFS
        run: |
          ipfs init
          ipfs config Addresses.API /ip4/127.0.0.1/tcp/5001
          ipfs config Addresses.Gateway /ip4/127.0.0.1/tcp/8080

      # 4Ô∏è‚É£ Start IPFS daemon in background
      - name: Start IPFS daemon
        run: |
          ipfs daemon &
          sleep 5
          ipfs swarm peers

      # 5Ô∏è‚É£ Add site folder to IPFS
      - name: Add folder to IPFS
        id: ipfs_add
        run: |
          if [ ! -d "site" ]; then
            echo "Error: site/ folder not found!"
            exit 1
          fi
          
          echo "Adding site folder to IPFS..."
          CID=$(ipfs add -r -Q site | tail -n 1)
          
          echo "Folder CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 6Ô∏è‚É£ Pin to Pinata
      - name: Pin to Pinata
        run: |
          echo "Pinning CID ${{ steps.ipfs_add.outputs.cid }} to Pinata..."
          
          RESPONSE=$(curl -X POST "https://api.pinata.cloud/pinning/pinByHash" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"hashToPin\": \"${{ steps.ipfs_add.outputs.cid }}\",
              \"pinataMetadata\": {
                \"name\": \"site-folder\"
              }
            }")
          
          echo "Pinata response: $RESPONSE"
          
          # Check if pinning was successful
          if echo "$RESPONSE" | grep -q "error"; then
            echo "Pinata pinning queued or already pinned"
          else
            echo "Successfully pinned to Pinata!"
          fi

      # 7Ô∏è‚É£ Make CID publicly available by connecting to public gateways
      - name: Announce to IPFS network
        run: |
          echo "Announcing CID to IPFS network..."
          
          # Try to fetch from public gateway to help propagate
          timeout 30 curl -I "https://ipfs.io/ipfs/${{ steps.ipfs_add.outputs.cid }}" || true
          
          echo "CID announced to network"

      # 8Ô∏è‚É£ Show final URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.ipfs_add.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.ipfs_add.outputs.cid }}/index.html"
          echo "üîó https://${{ steps.ipfs_add.outputs.cid }}.ipfs.dweb.link/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.ipfs_add.outputs.cid }}/"
          echo ""
          echo "Note: It may take a few moments for the content to propagate"
          echo "=========================================="