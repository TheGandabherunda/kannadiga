name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Install IPFS Kubo
      - name: Install IPFS Kubo
        run: |
          wget -q https://dist.ipfs.tech/kubo/v0.24.0/kubo_v0.24.0_linux-amd64.tar.gz
          tar -xzf kubo_v0.24.0_linux-amd64.tar.gz
          sudo bash kubo/install.sh
          ipfs version

      # 3Ô∏è‚É£ Add folder to IPFS locally and get CID
      - name: Add to IPFS
        id: ipfs_add
        run: |
          ipfs init
          ipfs add -r --quieter site > cid.txt
          CID=$(cat cid.txt)
          echo "CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Export as CAR file
      - name: Export as CAR
        run: |
          ipfs dag export ${{ steps.ipfs_add.outputs.cid }} > site.car
          ls -lh site.car

      # 5Ô∏è‚É£ Upload CAR to Pinata
      - name: Upload CAR to Pinata
        run: |
          echo "Uploading CAR file to Pinata..."
          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -F "file=@site.car")
          
          echo "Pinata response: $RESPONSE"
          
          PINATA_CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')
          echo "Pinata CID: $PINATA_CID"

      # 6Ô∏è‚É£ Show final URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.ipfs_add.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://ipfs.io/ipfs/${{ steps.ipfs_add.outputs.cid }}/"
          echo "üîó https://${{ steps.ipfs_add.outputs.cid }}.ipfs.dweb.link/"
          echo ""
          echo "Note: The CID is also pinned on Pinata"
          echo "=========================================="