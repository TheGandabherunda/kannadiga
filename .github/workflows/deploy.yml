name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3Ô∏è‚É£ Install requests library
      - name: Install dependencies
        run: pip install requests

      # 4Ô∏è‚É£ Verify site folder exists
      - name: Verify site folder
        run: |
          if [ ! -d "site" ]; then
            echo "Error: site/ folder not found!"
            exit 1
          fi
          echo "Found site folder, listing contents:"
          find site -type f

      # 5Ô∏è‚É£ Upload folder to Pinata
      - name: Upload to Pinata
        id: pinata_upload
        run: |
          cat << 'EOF' > upload_to_pinata.py
          import os
          import sys
          import json
          import requests
          from pathlib import Path

          def upload_folder_to_pinata(folder_path, jwt_token):
              url = "https://api.pinata.cloud/pinning/pinFileToIPFS"
              headers = {
                  "Authorization": f"Bearer {jwt_token}"
              }
          
              folder = Path(folder_path)
              files = []
              file_objects = []
          
              # Collect all files with their relative paths - all under 'file' field
              for file_path in folder.rglob('*'):
                  if file_path.is_file():
                      relative_path = str(file_path.relative_to(folder))
                      file_obj = open(file_path, 'rb')
                      file_objects.append(file_obj)
                      # All files must use 'file' as the field name with filename in tuple
                      files.append(('file', (relative_path, file_obj, 'application/octet-stream')))
          
              print(f"Uploading {len(files)} files to Pinata...")
          
              # Prepare form data
              data = {
                  'pinataMetadata': json.dumps({"name": "site-folder"}),
                  'pinataOptions': json.dumps({"wrapWithDirectory": True})
              }
          
              try:
                  response = requests.post(url, headers=headers, files=files, data=data)
                  response.raise_for_status()
          
                  result = response.json()
                  cid = result.get('IpfsHash')
          
                  if cid:
                      print(f"Success! CID: {cid}")
                      # Write to GitHub output
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                          f.write(f"cid={cid}\n")
                      return cid
                  else:
                      print(f"Error: No CID in response: {result}")
                      sys.exit(1)
          
              except requests.exceptions.RequestException as e:
                  print(f"Error uploading to Pinata: {e}")
                  if hasattr(e, 'response') and e.response is not None:
                      print(f"Response: {e.response.text}")
                  sys.exit(1)
              finally:
                  # Close all file handles
                  for file_obj in file_objects:
                      file_obj.close()

          if __name__ == "__main__":
              jwt = os.environ.get('PINATA_JWT')
              if not jwt:
                  print("Error: PINATA_JWT not found in environment")
                  sys.exit(1)
          
              upload_folder_to_pinata('site', jwt)
          EOF

          python upload_to_pinata.py
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}

      # 6Ô∏è‚É£ Show final CID & access URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "üîó https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Your index.html will be accessible at the root!"
          echo "=========================================="