name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Verify site folder exists
      - name: Verify site folder
        run: |
          if [ ! -d "site" ]; then
            echo "Error: site/ folder not found!"
            exit 1
          fi
          echo "Found site folder, listing contents:"
          find site -type f

      # 3Ô∏è‚É£ Upload folder to Pinata with proper structure
      - name: Upload to Pinata
        id: pinata_upload
        run: |
          echo "Uploading site folder to Pinata..."
          
          # Build curl command with all files maintaining directory structure
          CURL_CMD="curl -X POST 'https://api.pinata.cloud/pinning/pinFileToIPFS' \
            -H 'Authorization: Bearer ${{ secrets.PINATA_JWT }}'"
          
          # Add each file with its relative path
          cd site
          while IFS= read -r -d '' file; do
            relative_path="${file#./}"
            CURL_CMD="$CURL_CMD -F 'file=@$file;filename=$relative_path'"
          done < <(find . -type f -print0)
          cd ..
          
          # Add metadata
          CURL_CMD="$CURL_CMD -F 'pinataMetadata={\"name\":\"site-folder\"}'"
          CURL_CMD="$CURL_CMD -F 'pinataOptions={\"wrapWithDirectory\":true}'"
          
          # Execute upload
          RESPONSE=$(eval $CURL_CMD)
          
          echo "Pinata response: $RESPONSE"
          
          # Extract CID
          CID=$(echo "$RESPONSE" | grep -o '"IpfsHash":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$CID" ]; then
            echo "Error: Failed to extract CID from response"
            echo "Full response: $RESPONSE"
            exit 1
          fi
          
          echo "Successfully uploaded! CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Show final CID & access URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "üîó https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Your index.html will be at the root!"
          echo "=========================================="