name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Verify site folder exists
      - name: Verify site folder
        run: |
          if [ ! -d "site" ]; then
            echo "Error: site/ folder not found!"
            exit 1
          fi
          echo "Found site folder, listing contents:"
          find site -type f

      # 3Ô∏è‚É£ Upload to Pinata (without wrapWithDirectory)
      - name: Upload to Pinata
        id: pinata_upload
        run: |
          echo "Uploading site folder to Pinata..."
          
          # Build the curl command
          CURL_ARGS=()
          
          # Add all files
          while IFS= read -r file; do
            rel_path="${file#site/}"
            CURL_ARGS+=(-F "file=@${file};filename=${rel_path}")
          done < <(find site -type f)
          
          # Add metadata WITHOUT wrapWithDirectory
          CURL_ARGS+=(-F 'pinataMetadata={"name":"site-folder"}')
          
          # Execute upload
          RESPONSE=$(curl -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            "${CURL_ARGS[@]}")
          
          echo "Pinata response: $RESPONSE"
          
          # Extract CID
          CID=$(echo "$RESPONSE" | grep -o '"IpfsHash":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$CID" ]; then
            echo "Error: Failed to get CID"
            exit 1
          fi
          
          echo "Success! CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Show final URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "üîó https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "=========================================="