name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Verify site folder exists
      - name: Verify site folder
        run: |
          if [ ! -d "site" ]; then
            echo "Error: site/ folder not found!"
            exit 1
          fi
          echo "Found site folder, listing contents:"
          ls -R site/

      # 3ï¸âƒ£ Create a tarball of the site folder
      - name: Create tarball
        run: |
          tar -czf site.tar.gz -C site .
          echo "Tarball created successfully"
          ls -lh site.tar.gz

      # 4ï¸âƒ£ Upload folder to Pinata using File Upload API
      - name: Upload to Pinata
        id: pinata_upload
        run: |
          echo "Uploading site folder to Pinata..."
          
          RESPONSE=$(curl -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -F "file=@site.tar.gz" \
            -F "pinataMetadata={\"name\":\"site-folder\"}" \
            -F "pinataOptions={\"wrapWithDirectory\":false}")
          
          echo "Pinata response: $RESPONSE"
          
          # Extract CID from response
          CID=$(echo $RESPONSE | grep -o '"IpfsHash":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$CID" ]; then
            echo "Error: Failed to extract CID from response"
            echo "Full response: $RESPONSE"
            exit 1
          fi
          
          echo "Successfully uploaded! CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ Show final CID & access URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "âœ… Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "ğŸ”— https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "ğŸ”— https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "ğŸ”— https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "=========================================="