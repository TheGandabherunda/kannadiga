name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install form-data recursive-fs

      # 4Ô∏è‚É£ Create and run upload script
      - name: Upload to Pinata
        id: pinata_upload
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          cat << 'SCRIPT_EOF' > upload.js
          const fs = require('fs');
          const path = require('path');
          const FormData = require('form-data');
          const https = require('https');
          const recursiveFs = require('recursive-fs');

          async function uploadDirectory(sourcePath, jwt) {
            return new Promise((resolve, reject) => {
              recursiveFs.readdirr(sourcePath, (err, dirs, files) => {
                if (err) {
                  reject(err);
                  return;
                }

                const form = new FormData();

                // Add each file with its relative path
                files.forEach(file => {
                  const relativePath = path.relative(sourcePath, file);
                  form.append('file', fs.createReadStream(file), {
                    filepath: relativePath
                  });
                  console.log(`Adding: ${relativePath}`);
                });

                // Add metadata
                const metadata = JSON.stringify({
                  name: 'site-folder'
                });
                form.append('pinataMetadata', metadata);

                const options = JSON.stringify({
                  wrapWithDirectory: true
                });
                form.append('pinataOptions', options);

                // Make the request
                const requestOptions = {
                  method: 'POST',
                  hostname: 'api.pinata.cloud',
                  path: '/pinning/pinFileToIPFS',
                  headers: {
                    'Authorization': `Bearer ${jwt}`,
                    ...form.getHeaders()
                  }
                };

                const req = https.request(requestOptions, (res) => {
                  let data = '';

                  res.on('data', (chunk) => {
                    data += chunk;
                  });

                  res.on('end', () => {
                    if (res.statusCode === 200) {
                      try {
                        const result = JSON.parse(data);
                        resolve(result);
                      } catch (e) {
                        reject(new Error(`Failed to parse response: ${data}`));
                      }
                    } else {
                      reject(new Error(`Upload failed: ${res.statusCode} - ${data}`));
                    }
                  });
                });

                req.on('error', (error) => {
                  reject(error);
                });

                form.pipe(req);
              });
            });
          }

          async function main() {
            const jwt = process.env.PINATA_JWT;
            if (!jwt) {
              console.error('PINATA_JWT not found');
              process.exit(1);
            }

            try {
              console.log('Uploading site folder to Pinata...');
              const result = await uploadDirectory('./site', jwt);
          
              console.log('Upload successful!');
              console.log('CID:', result.IpfsHash);
          
              // Write to GitHub output
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `cid=${result.IpfsHash}\n`);
          
            } catch (error) {
              console.error('Upload failed:', error.message);
              process.exit(1);
            }
          }

          main();
          SCRIPT_EOF

          node upload.js

      # 5Ô∏è‚É£ Show final URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "üîó https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "üîó https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "üîó https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Your index.html will be at the root!"
          echo "=========================================="