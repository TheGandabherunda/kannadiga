name: Deploy HTML Site to Pinata/IPFS

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Install Node.js (needed for Pinata CLI)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3ï¸âƒ£ Verify site folder exists
      - name: Verify site folder
        run: |
          if [ ! -d "site" ]; then
            echo "Error: site/ folder not found!"
            exit 1
          fi
          echo "Found site folder, listing contents:"
          find site -type f

      # 4ï¸âƒ£ Upload folder to Pinata using CLI (preserves structure)
      - name: Upload to Pinata
        id: pinata_upload
        run: |
          echo "Uploading site folder to Pinata..."
          
          # Use Pinata CLI to upload the folder
          npx pinata upload folder site \
            --name "site-folder" \
            --jwt "${{ secrets.PINATA_JWT }}" \
            --json > pinata_response.json
          
          # Show response
          cat pinata_response.json
          
          # Extract CID
          CID=$(cat pinata_response.json | grep -o '"IpfsHash":"[^"]*"' | sed 's/"IpfsHash":"//;s/"//')
          
          if [ -z "$CID" ]; then
            echo "Error: Failed to extract CID"
            cat pinata_response.json
            exit 1
          fi
          
          echo "Successfully uploaded! CID: $CID"
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ Show final CID & access URLs
      - name: Show site URLs
        run: |
          echo "=========================================="
          echo "âœ… Deployment Successful!"
          echo "=========================================="
          echo "CID: ${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Access your site at:"
          echo "ğŸ”— https://gateway.pinata.cloud/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo "ğŸ”— https://${{ steps.pinata_upload.outputs.cid }}.ipfs.dweb.link/"
          echo "ğŸ”— https://ipfs.io/ipfs/${{ steps.pinata_upload.outputs.cid }}"
          echo ""
          echo "Note: Your index.html will be accessible at the root!"
          echo "=========================================="